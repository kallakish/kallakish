trigger: none

variables:
  - group: fabric_common   # Shared variables (tenant id, client id etc.)

stages:
- stage: DeployDev
  displayName: 'Deploy Fabric Workspace to Dev'
  variables:
    - name: environment
      value: 'dev'                 # Set environment name for this stage
    - group: fabric_${{ variables.environment }}   # Dev-specific variable group
    # All variables in fabric_common and fabric_dev are now usable as $(variable_name)
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Dev'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'

# Repeat for test/prod
- stage: DeployTest
  displayName: 'Deploy Fabric Workspace to Test'
  variables:
    - name: environment
      value: 'test'
    - group: fabric_${{ variables.environment }}
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'

- stage: DeployProd
  displayName: 'Deploy Fabric Workspace to Prod'
  variables:
    - name: environment
      value: 'prod'
    - group: fabric_${{ variables.environment }}
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Prod'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'


- task: PowerShell@2
  displayName: 'Create Fabric workspaces for all sources from config'
  inputs:
    targetType: 'inline'
    script: |
      $fabPath = "C:\Program Files\Python312\Scripts\fab.exe"
      $configPath = "$(Build.SourcesDirectory)\infra\workspaces.json"

      Write-Host "Loading workspace config from $configPath"
      $workspaces = Get-Content $configPath | ConvertFrom-Json

      foreach ($ws in $workspaces) {
        $name     = $ws.workspaceName
        $capacity = if ($ws.capacityName) { $ws.capacityName } else { "$(fabric_capacity_name)" }
        $admin    = if ($ws.adminObjectId) { $ws.adminObjectId } else { "$(fabric_workspace_admin_id)" }

        Write-Host "---------------------------------------------"
        Write-Host "Processing workspace: $name (source = $($ws.source))"
        
        & $fabPath exists "$name.Workspace"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "  - Workspace already exists – skipping create."
        }
        else {
          Write-Host "  - Workspace does not exist – creating..."
          & $fabPath create "$name.Workspace" -P "capacityname=$capacity"
        }

        Write-Host "  - Ensuring admin ACL..."
        & $fabPath acl set "$name.Workspace" -I $admin -R admin -f
      }
