trigger: none

variables:
  - group: fabric_common   # Shared variables (tenant id, client id etc.)

stages:
- stage: DeployDev
  displayName: 'Deploy Fabric Workspace to Dev'
  variables:
    - name: environment
      value: 'dev'                 # Set environment name for this stage
    - group: fabric_${{ variables.environment }}   # Dev-specific variable group
    # All variables in fabric_common and fabric_dev are now usable as $(variable_name)
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Dev'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'

# Repeat for test/prod
- stage: DeployTest
  displayName: 'Deploy Fabric Workspace to Test'
  variables:
    - name: environment
      value: 'test'
    - group: fabric_${{ variables.environment }}
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'

- stage: DeployProd
  displayName: 'Deploy Fabric Workspace to Prod'
  variables:
    - name: environment
      value: 'prod'
    - group: fabric_${{ variables.environment }}
  jobs:
  - job: DeployWorkspace
    displayName: 'Deploy Workspace in Prod'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        python -m pip install --upgrade pip
        pip install ms-fabric-cli
      displayName: 'Install Fabric CLI'
    - script: |
        fab auth login -u $(azure_client_id) -p $(azure_client_secret) --tenant $(azure_tenant_id)
      displayName: 'Fabric CLI Authentication'
    - script: |
        fab create $(workspace_name).Workspace -P capacityname=$(fabric_capacity_name)
      displayName: 'Create Fabric Workspace'
    - script: |
        fab acl set $(workspace_name).Workspace -I $(workspace_admin_id) -R admin -f
      displayName: 'Set Workspace Admin'


- task: PowerShell@2
  displayName: 'Create Fabric workspaces for all sources from config'
  inputs:
    targetType: 'inline'
    script: |
      $fabPath = "C:\Program Files\Python312\Scripts\fab.exe"
      $configPath = "$(Build.SourcesDirectory)\infra\workspaces.json"

      Write-Host "Loading workspace config from $configPath"
      $workspaces = Get-Content $configPath | ConvertFrom-Json

      foreach ($ws in $workspaces) {
        $name     = $ws.workspaceName
        $capacity = if ($ws.capacityName) { $ws.capacityName } else { "$(fabric_capacity_name)" }
        $admin    = if ($ws.adminObjectId) { $ws.adminObjectId } else { "$(fabric_workspace_admin_id)" }

        Write-Host "---------------------------------------------"
        Write-Host "Processing workspace: $name (source = $($ws.source))"
        
        & $fabPath exists "$name.Workspace"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "  - Workspace already exists – skipping create."
        }
        else {
          Write-Host "  - Workspace does not exist – creating..."
          & $fabPath create "$name.Workspace" -P "capacityname=$capacity"
        }

        Write-Host "  - Ensuring admin ACL..."
        & $fabPath acl set "$name.Workspace" -I $admin -R admin -f
      }
=====================================================================

jobs:
- job: DeployFabricWorkspaces
  displayName: 'Deploy Fabric workspaces from config'
  pool:
    name: 'Azure PreProd Pipelines'  # Your self-hosted Windows agent pool

  variables:
  - name: environment
    value: 'dev'
  - group: fabric_$(environment)      # variable group: fabric_dev

  steps:
  # 1. Install Fabric CLI
  - script: |
      "C:\Program Files\Python312\python.exe" -m pip install --upgrade pip
      "C:\Program Files\Python312\python.exe" -m pip install ms-fabric-cli
    displayName: 'Install Fabric CLI'

  # 2. Quick sanity check
  - script: |
      "C:\Program Files\Python312\Scripts\fab.exe" --version
    displayName: 'Fab Version'

  # 3. Authenticate Fabric CLI (Service Principal)
  - script: |
      "C:\Program Files\Python312\Scripts\fab.exe" auth login -u $(dev_client_id) -p $(dev_client_secret) --tenant $(tenant_id)
    displayName: 'Fabric CLI Authentication'

  # 4. Loop through workspaces.json and create/ACL each workspace
  - task: PowerShell@2
    displayName: 'Create Fabric workspaces for all sources from config'
    inputs:
      targetType: 'inline'
      script: |
        $fabPath    = "C:\Program Files\Python312\Scripts\fab.exe"
        $configPath = "$(Build.SourcesDirectory)\infra\workspaces.json"

        Write-Host "Loading workspace config from $configPath"

        if (-not (Test-Path $configPath)) {
          throw "Config file not found: $configPath"
        }

        $json       = Get-Content $configPath -Raw
        $workspaces = @(ConvertFrom-Json -InputObject $json)

        foreach ($ws in $workspaces) {
          $name = $ws.workspaceName
          if (-not $name) {
            Write-Warning "Skipping entry with no workspaceName"
            continue
          }

          # Fallback to pipeline variables if values not present in JSON
          $capacity = if ($ws.capacityName) { $ws.capacityName } else { "$(fabric_capacity_name)" }
          $admin    = if ($ws.adminObjectId) { $ws.adminObjectId } else { "$(fabric_workspace_admin_id)" }

          Write-Host "---------------------------------------------"
          Write-Host "Processing workspace: $name (source = $($ws.source))"

          # Check if workspace exists
          & $fabPath exists "$name.Workspace"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "  - Workspace already exists – skipping create."
          }
          else {
            Write-Host "  - Workspace does not exist – creating..."
            & $fabPath create "$name.Workspace" -P "capacityname=$capacity"

            if ($LASTEXITCODE -ne 0) {
              throw "Failed to create workspace '$name'. Exit code: $LASTEXITCODE"
            }
          }

          # Ensure admin ACL is set (idempotent)
          Write-Host "  - Ensuring admin ACL..."
          & $fabPath acl set "$name.Workspace" -I $admin -R admin -f

          if ($LASTEXITCODE -ne 0) {
            throw "Failed to set admin ACL for workspace '$name'. Exit code: $LASTEXITCODE"
          }
        }

        Write-Host "All workspaces from config processed successfully."
