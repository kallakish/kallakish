# install PyYAML (and anything else you want)
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install pyyaml
  displayName: 'Install generator deps'

# generate parameter.yml from DEV repo contents
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/generate_parameter_template.py ^
      --workspace-id $(workspace_id_clean) ^
      --workspace-root workspaces/workspace_alpha ^
      --output parameter.yml
  displayName: 'Generate parameter.yml (DEV template)'


  - powershell: |
    cd "$(Build.SourcesDirectory)"
    git config user.email "pipelines@devops"
    git config user.name  "Azure Pipelines"
    git status
    git add workspaces/mdf/parameter.yml
    git commit -m "Add/update parameter.yml (auto-generated)" 2>$null || echo "No changes to commit"
    git push origin HEAD:$(Build.SourceBranch)
  displayName: 'Commit parameter.yml to repo'




trigger:
- main

# Variable groups you already have
variables:
- group: Fabric-Secrets     # FABRIC_CLIENT_ID, FABRIC_TENANT_ID, FABRIC_CLIENT_SECRET
- group: fabric_common      # FABRIC_WORKSPACE_ID_DEV (etc.)

pool:
  name: Default   # your Windows agent

steps:
# Make sure we can push back to the same branch
- checkout: self
  persistCredentials: true

# -----------------------------------------------------------------------------
# Install shared Python deps (preflight + generator + deploy)
# -----------------------------------------------------------------------------
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install msal pyjwt requests pyyaml fabric-cicd==0.1.30
  displayName: 'Install Python packages'

# -----------------------------------------------------------------------------
# Preflight: prove token/tenant and workspace API access (sets $(workspace_id_clean))
# -----------------------------------------------------------------------------
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/pbi_access_preflight.py --workspace-id $(FABRIC_WORKSPACE_ID_DEV) --refresh
  displayName: 'Preflight: token & Power BI access'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# -----------------------------------------------------------------------------
# Generate parameter file into workspace/parameter_files/parameter_gen_dev.yml
# -----------------------------------------------------------------------------
- powershell: |
    $WS_ROOT = "$(Build.SourcesDirectory)/workspace"   # <-- change if your workspace folder is different
    $OUT     = "$(Build.SourcesDirectory)/workspace/parameter_files/parameter_gen_dev.yml"

    # Create parent folder (generator will too, but this makes the log clearer)
    New-Item -ItemType Directory -Force -Path (Split-Path $OUT) | Out-Null

    "C:/Program Files/Python312/python.exe" `
      "azure-pipelines/.deploy/generate_parameter_template.py" `
      --workspace-id "$(workspace_id_clean)" `
      --workspace-root "$WS_ROOT" `
      --output "$OUT"

    Write-Host "Generated file path: $OUT"
    if (Test-Path "$OUT") {
      Get-Content "$OUT" -Raw | Write-Host
    } else {
      Write-Error "parameter file not found at $OUT"
      exit 1
    }
  displayName: 'Generate parameter_gen_dev.yml'

# Publish the generated file so you can download it from the run
- task: PublishPipelineArtifact@1
  displayName: 'Publish parameter_gen_dev.yml'
  inputs:
    targetPath: '$(Build.SourcesDirectory)/workspace/parameter_files/parameter_gen_dev.yml'
    artifact: 'fabric-parameter-dev'

# -----------------------------------------------------------------------------
# Commit the generated file back to the repo (PowerShell 5.1 safe; no ||)
# -----------------------------------------------------------------------------
- task: PowerShell@2
  displayName: 'Commit parameter_gen_dev.yml to repo'
  inputs:
    targetType: inline
    # pwsh: false  # (default) Windows PowerShell
    script: |
      Set-StrictMode -Version Latest
      $ErrorActionPreference = 'Stop'
      cd "$(Build.SourcesDirectory)"

      git config --global --add safe.directory "$(Build.SourcesDirectory)"
      git config user.email "pipelines@devops"
      git config user.name  "Azure Pipelines"

      git add "workspace/parameter_files/parameter_gen_dev.yml"

      $status = git status --porcelain
      if ([string]::IsNullOrWhiteSpace($status)) {
        Write-Host "No changes to commit."
        exit 0
      }

      git commit -m "Add/update parameter_gen_dev.yml (auto-generated)"
      git push origin HEAD:"$(Build.SourceBranch)"

# -----------------------------------------------------------------------------
# Copy parameter_gen_dev.yml -> workspace/parameter.yml (name expected by fabric-cicd)
# -----------------------------------------------------------------------------
- powershell: |
    Copy-Item -Force `
      "$(Build.SourcesDirectory)/workspace/parameter_files/parameter_gen_dev.yml" `
      "$(Build.SourcesDirectory)/workspace/parameter.yml"
    Write-Host "parameter.yml ready at $(Build.SourcesDirectory)/workspace/parameter.yml"
  displayName: 'Prepare parameter.yml for deploy'

# -----------------------------------------------------------------------------
# Deploy content to DEV using the cleaned workspace id (from preflight)
# -----------------------------------------------------------------------------
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/deploy.py ^
      --workspace-id $(workspace_id_clean) ^
      --environment DEV ^
      --repo-dir "$(Build.SourcesDirectory)/workspace"
  displayName: 'Deploy to Fabric Workspace (DEV)'
  env:
    # Auth for DefaultAzureCredential (fabric-cicd)
    AZURE_CLIENT_ID: $(FABRIC_CLIENT_ID)
    AZURE_TENANT_ID: $(FABRIC_TENANT_ID)
    AZURE_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)
    SYSTEM_DEBUG: true

    # Example secrets consumed by parameter.yml (customize as needed)
    SQL_USER_DEV: $(SQL_USER_DEV)
    SQL_PASSWORD_DEV: $(SQL_PASSWORD_DEV)
    STORAGE_SAS_DEV: $(STORAGE_SAS_DEV)
