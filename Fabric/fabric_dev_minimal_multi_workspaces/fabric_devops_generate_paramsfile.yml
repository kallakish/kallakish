# install PyYAML (and anything else you want)
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install pyyaml
  displayName: 'Install generator deps'

# generate parameter.yml from DEV repo contents
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/generate_parameter_template.py ^
      --workspace-id $(workspace_id_clean) ^
      --workspace-root workspaces/workspace_alpha ^
      --output parameter.yml
  displayName: 'Generate parameter.yml (DEV template)'


  - powershell: |
    cd "$(Build.SourcesDirectory)"
    git config user.email "pipelines@devops"
    git config user.name  "Azure Pipelines"
    git status
    git add workspaces/mdf/parameter.yml
    git commit -m "Add/update parameter.yml (auto-generated)" 2>$null || echo "No changes to commit"
    git push origin HEAD:$(Build.SourceBranch)
  displayName: 'Commit parameter.yml to repo'


trigger: none

variables:
- group: fabric_common   # must contain FABRIC_WORKSPACE_ID_DEV

pool:
  name: Default  # Windows agent

steps:
- checkout: self
  persistCredentials: true

# Install the one dependency the generator needs
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install pyyaml
  displayName: 'Install PyYAML'

# Generate the file at workspace/parameter_files/parameter_gen_dev.yml
- powershell: |
    $WS_ROOT = "$(Build.SourcesDirectory)/workspace"   # <--- change if your workspace folder is different
    $OUT     = "$(Build.SourcesDirectory)/workspace/parameter_files/parameter_gen_dev.yml"

    New-Item -ItemType Directory -Force -Path (Split-Path $OUT) | Out-Null

    "C:/Program Files/Python312/python.exe" `
      "azure-pipelines/.deploy/generate_parameter_template.py" `
      --workspace-id "$(FABRIC_WORKSPACE_ID_DEV)" `
      --workspace-root "$WS_ROOT" `
      --output "$OUT"

    Write-Host "Generated: $OUT"
    if (Test-Path "$OUT") {
      Get-Content "$OUT" -Raw | Write-Host
    } else {
      Write-Error "parameter file not found at $OUT"
      exit 1
    }
  displayName: 'Generate parameter_gen_dev.yml'

# Commit and push the generated file back to the repo (PowerShell 5.1-safe)
- task: PowerShell@2
  displayName: 'Commit parameter_gen_dev.yml to repo'
  inputs:
    targetType: inline
    script: |
      Set-StrictMode -Version Latest
      $ErrorActionPreference = 'Stop'
      cd "$(Build.SourcesDirectory)"

      git config --global --add safe.directory "$(Build.SourcesDirectory)"
      git config user.email "pipelines@devops"
      git config user.name  "Azure Pipelines"

      git add "workspace/parameter_files/parameter_gen_dev.yml"

      $status = git status --porcelain
      if ([string]::IsNullOrWhiteSpace($status)) {
        Write-Host "No changes to commit."
        exit 0
      }

      git commit -m "Add/update parameter_gen_dev.yml (auto-generated)"
      git push origin HEAD:"$(Build.SourceBranch)"
