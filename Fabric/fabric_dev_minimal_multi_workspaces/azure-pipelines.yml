# trigger:
# - main

# pool:
#   name: Default   # Your self-hosted agent pool if applicable

# variables:
# - group: Fabric-Secrets    # FABRIC_CLIENT_ID, FABRIC_TENANT_ID, FABRIC_CLIENT_SECRET
# - group: fabric_common     # FABRIC_WORKSPACE_ID_DEV, FABRIC_WORKSPACE_ID_TEST, FABRIC_WORKSPACE_ID_PROD

# stages:
# - stage: Deploy_Dev
#   displayName: 'Deploy to DEV'
#   jobs:
#   - job: Deploy_Dev_Job
#     displayName: 'Deploy DEV Fabric Workspace'
#     steps:
#     - script: |
#         "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
#         "C:/Program Files/Python312/python.exe" -m pip install fabric-cicd
#       displayName: 'Install fabric-cicd'
#     - script: |
#         "C:/Program Files/Python312/python.exe" deploy.py --workspace-id $(FABRIC_WORKSPACE_ID_DEV) --environment DEV --repo-dir workspaces/workspace_alpha/fabric_items
#       displayName: 'Deploy DEV Items'
#       env:
#         FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
#         FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
#         FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# - stage: Deploy_Test
#   displayName: 'Deploy to TEST'
#   dependsOn: Deploy_Dev
#   jobs:
#   - job: Deploy_Test_Job
#     displayName: 'Deploy TEST Fabric Workspace'
#     steps:
#     - script: |
#         "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
#         "C:/Program Files/Python312/python.exe" -m pip install fabric-cicd
#       displayName: 'Install fabric-cicd'
#     - script: |
#         "C:/Program Files/Python312/python.exe" deploy.py --workspace-id $(FABRIC_WORKSPACE_ID_TEST) --environment TEST --repo-dir workspaces/workspace_alpha/fabric_items
#       displayName: 'Deploy TEST Items'
#       env:
#         FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
#         FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
#         FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# - stage: Deploy_Prod
#   displayName: 'Deploy to PROD'
#   dependsOn: Deploy_Test
#   jobs:
#   - job: Deploy_Prod_Job
#     displayName: 'Deploy PROD Fabric Workspace'
#     steps:
#     - script: |
#         "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
#         "C:/Program Files/Python312/python.exe" -m pip install fabric-cicd
#       displayName: 'Install fabric-cicd'
#     - script: |
#         "C:/Program Files/Python312/python.exe" deploy.py --workspace-id $(FABRIC_WORKSPACE_ID_PROD) --environment PROD --repo-dir workspaces/workspace_alpha/fabric_items
#       displayName: 'Deploy PROD Items'
#       env:
#         FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
#         FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
#         FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)
trigger:
- main

variables:
- group: Fabric-Secrets    # FABRIC_CLIENT_ID, FABRIC_TENANT_ID, FABRIC_CLIENT_SECRET
- group: fabric_common     # workspace IDs

pool:
  name: Default

steps:
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install fabric-cicd
    "C:/Program Files/Python312/python.exe" -m pip install msal pyjwt
  displayName: 'Install packages'

- script: |
    - script: |
    "C:/Program Files/Python312/python.exe" print_token_claims.py
  displayName: 'Print SPN Token Claims'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)


- script: |
    "C:/Program Files/Python312/python.exe" deploy.py --workspace-id $(FABRIC_WORKSPACE_ID_DEV) --environment DEV --repo-dir workspaces/workspace_alpha/fabric_items
  displayName: 'Deploy to Fabric Workspace'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)




# Install deps once (msal, pyjwt, requests)
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install msal pyjwt requests
  displayName: 'Install preflight deps'

# Run the preflight; it will set $(workspace_id_clean) for later steps
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/pbi_access_preflight.py --workspace-id $(FABRIC_WORKSPACE_ID_DEV) --refresh
  displayName: 'Preflight: token & PBI access'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# Use the cleaned ID in your deploy
- script: |
    "C:/Program Files/Python312/python.exe" deploy.py --workspace-id $(workspace_id_clean) --environment DEV --repo-dir workspaces/workspace_alpha/fabric_items
  displayName: 'Deploy to Fabric Workspace'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)



#=====================================================================================




# Install deps (preflight + deploy)
- script: |
    "C:/Program Files/Python312/python.exe" -m pip install --upgrade pip
    "C:/Program Files/Python312/python.exe" -m pip install msal pyjwt requests fabric-cicd==0.1.30
  displayName: 'Install packages'

# Preflight: proves API access and sets $(workspace_id_clean)
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/pbi_access_preflight.py --workspace-id $(FABRIC_WORKSPACE_ID_DEV) --refresh
  displayName: 'Preflight: token & PBI access'
  env:
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# Deploy: uses AZURE_* so fabric-cicd authenticates as the same SPN
- script: |
    "C:/Program Files/Python312/python.exe" azure-pipelines/.deploy/deploy.py ^
      --workspace-id $(workspace_id_clean) ^
      --environment DEV ^
      --repo-dir workspaces/workspace_alpha/fabric_items
  displayName: 'Deploy to Fabric Workspace (fabric-cicd)'
  env:
    # If your deploy.py or other libs read FABRIC_*, keep them too
    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)
    # Critical for DefaultAzureCredential:
    AZURE_CLIENT_ID: $(FABRIC_CLIENT_ID)
    AZURE_TENANT_ID: $(FABRIC_TENANT_ID)
    AZURE_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)
    SYSTEM_DEBUG: true


