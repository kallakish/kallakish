# Azure DevOps multi-stage pipeline for Microsoft Fabric deployments via fabric-cicd
# Stages: Dev -> Test -> Prod
# Each stage binds to its own Variable Group so you can keep workspace IDs & ENV separate.

trigger:
  branches:
    include:
      - main
      - dev

pool:
  vmImage: 'windows-latest'

# Toggle which stages to run (you can also set these at queue time)
variables:
  RUN_DEV: 'true'
  RUN_TEST: 'false'
  RUN_PROD: 'false'

stages:
# =====================
# DEV
# =====================
- stage: DevDeploy
  displayName: 'Deploy to DEV'
  condition: and(succeeded(), eq(variables['RUN_DEV'], 'true'))
  variables:
  - group: Fabric-Common   # TENANT_ID, CLIENT_ID, CLIENT_SECRET (secrets)
  - group: Fabric-Dev      # ENVIRONMENT=dev, WORKSPACE_ID_DEV
  jobs:
  - job: Deploy
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.12'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install fabric-cicd azure-identity
      displayName: 'Install fabric-cicd'

    - task: AzureCLI@2
      displayName: 'Deploy Fabric items (DEV)'
      inputs:
        azureSubscription: 'your-service-connection'   # <-- CHANGE ME
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          # Expose secrets for fabric-cicd auth (SPN), or rely on the service connection's AzureCLI context
          if ("$(TENANT_ID)" -and "$(CLIENT_ID)" -and "$(CLIENT_SECRET)") {
            $env:TENANT_ID = "$(TENANT_ID)"
            $env:CLIENT_ID = "$(CLIENT_ID)"
            $env:CLIENT_SECRET = "$(CLIENT_SECRET)"
          }
          python -u ./.deploy/fabric_workspace.py `
            --environment $(ENVIRONMENT) `
            --workspace_id_dev $(WORKSPACE_ID_DEV)

# =====================
# TEST
# =====================
- stage: TestDeploy
  displayName: 'Deploy to TEST'
  dependsOn: DevDeploy
  condition: and(succeeded(), eq(variables['RUN_TEST'], 'true'))
  variables:
  - group: Fabric-Common   # TENANT_ID, CLIENT_ID, CLIENT_SECRET (secrets)
  - group: Fabric-Test     # ENVIRONMENT=test, WORKSPACE_ID_TEST
  jobs:
  - job: PreApproval
    displayName: 'Manual approval for TEST'
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: 'Approve to deploy to TEST workspace.'
        onTimeout: 'reject'
        timeout: '0'  # no timeout
  - job: Deploy
    dependsOn: PreApproval
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.12'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install fabric-cicd azure-identity
      displayName: 'Install fabric-cicd'

    - task: AzureCLI@2
      displayName: 'Deploy Fabric items (TEST)'
      inputs:
        azureSubscription: 'your-service-connection'   # <-- CHANGE ME
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          if ("$(TENANT_ID)" -and "$(CLIENT_ID)" -and "$(CLIENT_SECRET)") {
            $env:TENANT_ID = "$(TENANT_ID)"
            $env:CLIENT_ID = "$(CLIENT_ID)"
            $env:CLIENT_SECRET = "$(CLIENT_SECRET)"
          }
          python -u ./.deploy/fabric_workspace.py `
            --environment $(ENVIRONMENT) `
            --workspace_id_test $(WORKSPACE_ID_TEST)

# =====================
# PROD
# =====================
- stage: ProdDeploy
  displayName: 'Deploy to PROD'
  dependsOn: TestDeploy
  condition: and(succeeded(), eq(variables['RUN_PROD'], 'true'))
  variables:
  - group: Fabric-Common   # TENANT_ID, CLIENT_ID, CLIENT_SECRET (secrets)
  - group: Fabric-Prod     # ENVIRONMENT=prod, WORKSPACE_ID_PROD
  jobs:
  - job: PreApproval
    displayName: 'Manual approval for PROD'
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: 'Approve to deploy to PROD workspace.'
        onTimeout: 'reject'
        timeout: '0'  # no timeout
  - job: Deploy
    dependsOn: PreApproval
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.12'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install fabric-cicd azure-identity
      displayName: 'Install fabric-cicd'

    - task: AzureCLI@2
      displayName: 'Deploy Fabric items (PROD)'
      inputs:
        azureSubscription: 'your-service-connection'   # <-- CHANGE ME
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          if ("$(TENANT_ID)" -and "$(CLIENT_ID)" -and "$(CLIENT_SECRET)") {
            $env:TENANT_ID = "$(TENANT_ID)"
            $env:CLIENT_ID = "$(CLIENT_ID)"
            $env:CLIENT_SECRET = "$(CLIENT_SECRET)"
          }
          python -u ./.deploy/fabric_workspace.py `
            --environment $(ENVIRONMENT) `
            --workspace_id_prod $(WORKSPACE_ID_PROD)









- powershell: |
    # (optional) refresh PATH in case the agent service hasn't been restarted
    $env:Path = [Environment]::GetEnvironmentVariable('Path','Machine') + ';' +
                [Environment]::GetEnvironmentVariable('Path','User')

    python -m pip install --upgrade pip
    pip install fabric-cicd azure-identity
  displayName: 'Install fabric-cicd'



  trigger: none  # run manually

pool:
  name: 'azure preprod pipelines'   # <-- your self-hosted pool

stages:
- stage: Setup
  jobs:
  - job: InstallFabricCICD
    steps:
    - powershell: |
        # Refresh PATH (handy if the agent service was started before Python install)
        $env:Path = [Environment]::GetEnvironmentVariable('Path','Machine') + ';' +
                    [Environment]::GetEnvironmentVariable('Path','User')

        python -V
        # optional but recommended to avoid old-pip issues:
        python -m pip install --upgrade pip

        # install fabric-cicd (pin to the doc version) + auth helper
        pip install fabric-cicd==0.1.30 azure-identity

        # quick sanity check
        python - << 'PY'
import importlib.metadata as m
print("fabric-cicd", m.version("fabric-cicd"))
PY
      displayName: 'Install fabric-cicd'




      - task: AzureCLI@2
  displayName: 'Deploy Fabric items (DEV)'
  inputs:
    azureSubscription: 'your-service-connection'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      $ErrorActionPreference = 'Stop'

      # Adjust this path to where you installed Python
      $py = "C:\Program Files\Python312\python.exe"
      if (-not (Test-Path $py)) { $py = "$env:LOCALAPPDATA\Programs\Python\Python312\python.exe" }

      if ("$(TENANT_ID)" -and "$(CLIENT_ID)" -and "$(CLIENT_SECRET)") {
        $env:TENANT_ID = "$(TENANT_ID)"
        $env:CLIENT_ID = "$(CLIENT_ID)"
        $env:CLIENT_SECRET = "$(CLIENT_SECRET)"
      }

      & $py -V
      & $py -u .\.deploy\fabric_workspace.py `
        --environment $(ENVIRONMENT) `
        --workspace_id_dev $(WORKSPACE_ID_DEV)



        - powershell: |
    Write-Host "Looking for config.yml at $(Build.SourcesDirectory)\config.yml"
    if (Test-Path "$(Build.SourcesDirectory)\config.yml") {
      Get-Content "$(Build.SourcesDirectory)\config.yml"
    } else {
      Write-Host "Not found at repo root."
    }


config_override = {
        "features": ["enable_experimental_features", "enable_config_deploy"]
    }
    if override_ws:
        config_override["core"] = {"workspace_id": override_ws}






- task: AzureCLI@2
  displayName: 'Deploy via venv (DEV)'
  inputs:
    azureSubscription: 'your-service-connection'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference = 'Stop'

      $py = "C:\Program Files\Python312\python.exe"
      & $py -m venv .venv
      & .\.venv\Scripts\python.exe -m pip install -U pip fabric-cicd==0.1.30 azure-identity

      if ("$(TENANT_ID)" -and "$(CLIENT_ID)" -and "$(CLIENT_SECRET)") {
        $env:TENANT_ID = "$(TENANT_ID)"
        $env:CLIENT_ID = "$(CLIENT_ID)"
        $env:CLIENT_SECRET = "$(CLIENT_SECRET)"
      }

      & .\.venv\Scripts\python.exe -V
      & .\.venv\Scripts\python.exe -u .\.deploy\fabric_workspace.py `
        --environment $(ENVIRONMENT) `
        --workspace_id_dev $(WORKSPACE_ID_DEV)



// 2 pass deployment very important:


# PASS 1 — anchors (creates the things others depend on)
- powershell: |
    & "C:\Program Files\Python312\python.exe" azure-pipelines\.deploy\deploy.py `
      --workspace-id $(TEST_WORKSPACE_ID) `
      --environment TEST `
      --repo-dir "$(Build.SourcesDirectory)\workspaces\<your-workspace>" `
      --items-in-scope "Lakehouse,Warehouse,KQLDatabase,Environment,SemanticModel"
  displayName: 'TEST Pass 1: anchors'
  env:
    AZURE_CLIENT_ID: $(FABRIC_CLIENT_ID)
    AZURE_TENANT_ID: $(FABRIC_TENANT_ID)
    AZURE_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

# PASS 2 — dependents (pipelines, notebooks, reports)
- powershell: |
    & "C:\Program Files\Python312\python.exe" azure-pipelines\.deploy\deploy.py `
      --workspace-id $(TEST_WORKSPACE_ID) `
      --environment TEST `
      --repo-dir "$(Build.SourcesDirectory)\workspaces\<your-workspace>" `
      --items-in-scope "DataPipeline,Notebook,Report"
  displayName: 'TEST Pass 2: dependents'
  env:
    AZURE_CLIENT_ID: $(FABRIC_CLIENT_ID)
    AZURE_TENANT_ID: $(FABRIC_TENANT_ID)
    AZURE_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)
    # any secrets your parameter.yml references via $env:
    SQL_USERNAME_TEST: $(SQL_USERNAME_TEST)
    SQL_PASSWORD_TEST: $(SQL_PASSWORD_TEST)





#Check the 


- task: AzureCLI@2
  displayName: 'Ensure RBAC on capacity + workspaces'
  inputs:
    azureSubscription: 'your-service-connection'   # SPN with required permissions
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      $py = 'C:\Program Files\Python312\python.exe'
      & $py -m pip install -U pip requests azure-identity

      # env for ARM
      $env:AZ_SUBSCRIPTION_ID = '$(AZ_SUBSCRIPTION_ID)'
      $env:AZ_RESOURCE_GROUP  = '$(AZ_RESOURCE_GROUP)'

      # (optional) explicit SPN; otherwise DefaultAzureCredential uses the service connection login
      # $env:TENANT_ID = '$(TENANT_ID)'
      # $env:CLIENT_ID = '$(CLIENT_ID)'
      # $env:CLIENT_SECRET = '$(CLIENT_SECRET)'

      # path to your JSON file (checked into repo)
      $env:RBAC_PARAMS_FILE = 'capacity-admins.json'

      & $py -u .\.deploy\ensure_rbac.py
