parameters:
  artifactName: 'arm'
  armTemplateFile: 'ARMTemplateForFactory.json'

  azureServiceConnection: ''
  subscriptionId: ''
  resourceGroupName: ''
  location: ''
  parametersFile: ''

steps:
- checkout: self

- download: current
  artifact: ${{ parameters.artifactName }}

# Ensure python exists (works on hosted agents; safe on self-hosted too if installed)
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: >
    python -c "import json; 
    p=r'$(Build.SourcesDirectory)\ArmTemplate\ARMTemplateForFactory.json';
    o=r'$(Build.SourcesDirectory)\ArmTemplate\ARMTemplateForFactory.noir.json';
    d=json.load(open(p,'r',encoding='utf-8'));
    d['resources']=[r for r in d.get('resources',[]) if str(r.get('type','')).lower()!='microsoft.datafactory/factories/integrationruntimes'];
    json.dump(d, open(o,'w',encoding='utf-8'), ensure_ascii=False, separators=(',',':'))"
  displayName: Create ARM template without IR


  - task: PowerShell@2
  displayName: List ARM files
  inputs:
    pwsh: false
    targetType: inline
    script: |
      dir "$(Pipeline.Workspace)\arm"


- task: AzureResourceManagerTemplateDeployment@3
  displayName: ARM Deploy ADF (IR skipped)
  inputs:
    deploymentScope: Resource Group
    azureResourceManagerConnection: ${{ parameters.azureServiceConnection }}
    subscriptionId: ${{ parameters.subscriptionId }}
    action: Create Or Update Resource Group
    resourceGroupName: ${{ parameters.resourceGroupName }}
    location: ${{ parameters.location }}
    templateLocation: Linked artifact
    csmFile: "$(Pipeline.Workspace)/${{ parameters.artifactName }}/ARMTemplateForFactory.noir.json"
    csmParametersFile: ${{ parameters.parametersFile }}
    deploymentMode: Incremental

