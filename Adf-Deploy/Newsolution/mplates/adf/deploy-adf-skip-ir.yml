parameters:
  artifactName: 'arm'
  armTemplateFile: 'ARMTemplateForFactory.json'

  azureServiceConnection: ''
  subscriptionId: ''
  resourceGroupName: ''
  location: ''
  parametersFile: ''

steps:
- checkout: self

- download: current
  artifact: ${{ parameters.artifactName }}

# Ensure python exists (works on hosted agents; safe on self-hosted too if installed)
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: >
    python scripts/adf/remove_ir_from_arm.py
    "$(Pipeline.Workspace)/${{ parameters.artifactName }}/${{ parameters.armTemplateFile }}"
    "$(Pipeline.Workspace)/${{ parameters.artifactName }}/ARMTemplateForFactory.noir.json"
  displayName: Prepare ARM (remove IR)

- task: AzureResourceManagerTemplateDeployment@3
  displayName: ARM Deploy ADF (IR skipped)
  inputs:
    deploymentScope: Resource Group
    azureResourceManagerConnection: ${{ parameters.azureServiceConnection }}
    subscriptionId: ${{ parameters.subscriptionId }}
    action: Create Or Update Resource Group
    resourceGroupName: ${{ parameters.resourceGroupName }}
    location: ${{ parameters.location }}
    templateLocation: Linked artifact
    csmFile: "$(Pipeline.Workspace)/${{ parameters.artifactName }}/ARMTemplateForFactory.noir.json"
    csmParametersFile: ${{ parameters.parametersFile }}
    deploymentMode: Incremental

